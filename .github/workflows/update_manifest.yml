name: Update Test Manifest

on:
  # Trigger 1: Automatic (When you push a JSON file)
  push:
    paths:
      - 'tests/*.json'
  
  # Trigger 2: Manual (The "Fix It" Button)
  workflow_dispatch: 

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3

      - name: Generate Manifest
        run: |
          echo "[" > tests/test_manifest.json
          first=true
          for file in tests/*.json; do
            if [ "$(basename "$file")" != "test_manifest.json" ]; then
              if [ "$first" = true ]; then
                first=false
              else
                echo "," >> tests/test_manifest.json
              fi
              
              FILENAME=$(basename "$file")
              NAME="${FILENAME%.*}"
              # We use qCount: 0 as a placeholder since we aren't reading file content here
              echo "{\"name\": \"$NAME\", \"filename\": \"$FILENAME\", \"qCount\": 0}" >> tests/test_manifest.json
            fi
          done
          echo "]" >> tests/test_manifest.json

      - name: Commit and Push
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git add tests/test_manifest.json
          git commit -m "Manual update of test manifest" || echo "No changes to commit"
          git push
