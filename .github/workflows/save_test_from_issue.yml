name: Save Test from Issue
on:
  issues:
    types: [opened, labeled]  # <--- Added 'labeled' so it works if you add the label later

permissions:
  contents: write
  issues: write

jobs:
  save-json:
    if: contains(github.event.issue.labels.*.name, 'new-test')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Save JSON to Tests Folder
        env:
          JSON_CONTENT: ${{ github.event.issue.body }}
          FILE_NAME: ${{ github.event.issue.title }}
        run: |
          mkdir -p tests
          echo "$JSON_CONTENT" > "tests/$FILE_NAME"
          
          # Simple validation
          if jq -e . "tests/$FILE_NAME" >/dev/null 2>&1; then
            echo "Valid JSON detected."
          else
            echo "Error: Invalid JSON format."
            rm "tests/$FILE_NAME"
            exit 1
          fi

      - name: Commit and Push
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git add "tests/${{ github.event.issue.title }}"
          git commit -m "Added test via Issue Ops: ${{ github.event.issue.title }}"
          git push

      - name: Close Issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUM: ${{ github.event.issue.number }}
        run: |
          gh issue close $ISSUE_NUM --comment "âœ… Success! File created: tests/${{ github.event.issue.title }}"
