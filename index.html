<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Exam Mock Tool</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìò</text></svg>">
    <style>
        :root {
            --header-bg: #1a237e;
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --text-color: #333;
            --accent: #2962ff;
            --correct: #2ecc71;
            --wrong: #e74c3c;
            --footer-height: 80px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        body { height: 100dvh; width: 100vw; overflow: hidden; background: var(--bg-color); display: flex; flex-direction: column; }

        /* SCREENS */
        .screen { display: none; height: 100%; width: 100%; flex-direction: column; }
        #upload-screen.active, #result-screen.active { display: block; overflow-y: auto; }
        #exam-screen.active { display: flex; } 

        /* UPLOAD SCREEN */
        .container-box { max-width: 900px; margin: 20px auto; padding: 0 20px 160px 20px; }
        .filter-bar { margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .exam-select { width: 100%; padding: 12px; border: 2px solid var(--accent); border-radius: 6px; font-size: 1rem; font-weight: bold; color: var(--accent); background: white; margin-bottom: 15px; cursor: pointer; outline: none; }
        .search-box { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; margin-bottom: 10px; }
        
        .library-box { background: var(--card-bg); padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        /* NEW BUTTON GROUP STYLING */
        .lib-controls { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: space-between; margin-bottom: 15px; }
        .btn-row { display: flex; gap: 10px; }
        
        .toggle-btn { background: #eee; color: #333; padding: 8px 16px; border-radius: 6px; cursor: pointer; border: 1px solid #ccc; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; font-weight: 500; transition: 0.2s; }
        .toggle-btn:hover { background: #e0e0e0; }
        .toggle-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
        .paste-btn { background: #e3f2fd; color: var(--accent); border: 1px solid var(--accent); }
        .upload-btn { background: #fff3e0; color: #e65100; border: 1px solid #ffb74d; }
        
        input[type="file"] { display: none; }

        /* LIST VIEW */
        .file-grid { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; }
        .file-card { background: #fff; border: 1px solid #eee; padding: 12px 15px; border-radius: 6px; cursor: pointer; display: flex; flex-direction: row; align-items: center; position: relative; transition: 0.2s; }
        .file-card:hover { border-color: var(--accent); background: #f9f9f9; }
        .file-card:not(.cloud-item) { padding-right: 45px !important; }
        .file-card.active { border: 1px solid var(--accent); background: #e3f2fd; }
        .file-name { font-weight: 600; font-size: 0.95rem; color: #333; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 10px; }
        .file-meta { font-size: 0.85rem; color: #888; min-width: 60px; text-align: right; }
        .del-btn { position: absolute; right: 12px; color: #ff5252; font-size: 1.6rem; font-weight: bold; cursor: pointer; display: none; }
        .file-card:not(.cloud-item) .del-btn { display: block; }
        .status-badge { font-size: 1.2rem; margin-right: 15px; width: 25px; text-align: center; }
        .multi-check { margin-left: 10px; background: var(--accent); color: white; border-radius: 50%; width: 22px; height: 22px; display: none; align-items: center; justify-content: center; font-size: 0.7rem; }
        .file-card.multi-selected .multi-check { display: flex; }

        /* HISTORY TABLE STYLING */
        .history-box { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .styled-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; margin-top: 10px; }
        .styled-table thead tr { background-color: #f8f9fa; text-align: left; }
        .styled-table th, .styled-table td { padding: 12px 15px; border-bottom: 1px solid #dddddd; }
        .styled-table tbody tr:hover { background-color: #f1f1f1; }
        .styled-table th { color: #555; font-weight: 600; }
        button.retake { background: #27ae60; padding: 6px 12px; font-size: 0.8rem; color: white; border:none; border-radius:4px; cursor:pointer; font-weight: bold; }
        button.clear { background: transparent; color: #e74c3c; text-decoration: underline; padding: 0; border: none; cursor:pointer;}

        /* MODAL */
        #pasteModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 5000; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 500px; display: flex; flex-direction: column; gap: 10px; }
        .modal-content textarea { width: 100%; height: 200px; padding: 10px; border: 1px solid #ccc; font-family: monospace; }
        .modal-actions { display: flex; justify-content: space-between; margin-top: 10px; }

        /* FOOTER */
        .fixed-footer { position: fixed; bottom: 0; left: 0; width: 100%; background: #fff; border-top: 1px solid #ccc; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; z-index: 2000; padding-bottom: calc(15px + env(safe-area-inset-bottom)); }
        .time-row { display: flex; align-items: center; gap: 5px; }
        .mini-input { width: 65px; padding: 10px; text-align: center; border: 2px solid #ddd; border-radius: 8px; font-size: 1.3rem; font-weight: bold; }
        .start-btn { width: 180px; height: 50px; background: var(--accent); color: white; font-weight: bold; border: none; border-radius: 8px; font-size: 1.1rem; cursor: pointer; }
        .start-btn:disabled { background: #ccc; cursor: not-allowed; }
        .resume-btn { width: 120px; height: 50px; background: #f39c12; color: white; border: none; border-radius: 8px; font-weight: bold; display: none; margin-right: 10px; }

        /* EXAM SCREEN */
        header { height: 60px; background: var(--header-bg); color: white; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 3000; }
        header.review-mode { background: #343a40; border-bottom: 3px solid #ffc107; }
        .timer { font-weight: bold; background: #222; color: #00ff00; padding: 5px 10px; border-radius: 4px; font-family: monospace; font-size: 1.1rem; }
        .exam-layout { display: flex; flex: 1; width: 100%; overflow: hidden; background: #e9ecef; position: relative; }
        .pane-passage { flex: 1; background: #fffbf2; padding: 25px; overflow-y: auto; border-right: 1px solid #ddd; font-family: Georgia, serif; display: none; }
        .pane-passage.active { display: block; }
        .pane-question { flex: 1.2; background: #fff; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; min-width: 300px; }
        .q-meta { display: flex; justify-content: space-between; font-weight: bold; color: #777; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .q-text { font-size: 1.15rem; margin-bottom: 20px; font-weight: 500; }
        .opt-label { padding: 12px; border: 1px solid #eee; margin-bottom: 10px; border-radius: 6px; cursor: pointer; display: flex; align-items: flex-start; }
        .opt-label.selected { background: #e3f2fd; border-color: var(--accent); }
        .opt-label input { margin-right: 10px; margin-top: 4px; }
        .pane-sidebar { width: 300px; background: #fff; display: flex; flex-direction: column; transition: width 0.3s ease; }
        .pane-sidebar.collapsed { width: 0; overflow: hidden; }
        .palette-grid { flex: 1; overflow-y: auto; padding: 15px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; align-content: start; }
        .pal-btn { height: 35px; border: 1px solid #ddd; background: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .pal-btn.ans { background: var(--correct); color: white; border: none; }
        .pal-btn.visit { background: #e74c3c; color: white; border: none; }
        .sidebar-handle { width: 15px; background: #dcdcdc; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        
        .conf-box { margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px; pointer-events: none; opacity: 0.5; }
        .conf-box.active { pointer-events: auto; opacity: 1; background: #e3f2fd; }
        .conf-opts { display: flex; gap: 5px; margin-top: 5px; }
        .c-btn { flex: 1; padding: 10px 5px; border: 1px solid #ccc; background: white; text-align: center; cursor: pointer; border-radius: 4px; font-size: 0.85rem; font-weight: 500; }
        .c-btn.sel { background: #673ab7; color: white; border-color: #5e35b1; }

        /* RESULTS */
        .result-container { max-width: 850px; margin: 40px auto; padding-bottom: 50px; }
        .score-row { display: flex; justify-content: center; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; }
        .score-card { background: white; padding: 20px; border-radius: 8px; width: 150px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-top: 4px solid #ccc; }
        .score-card.tot { border-color: var(--accent); }
        .score-card.cor { border-color: var(--correct); }
        .score-card.wrg { border-color: var(--wrong); }
        .analysis-section { background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); padding: 20px; margin-bottom: 25px; }
        .review-item { background: white; border-left: 5px solid #ccc; padding: 15px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .review-item.correct { border-left-color: var(--correct); }
        .review-item.wrong { border-left-color: var(--wrong); }
        .txt-green { color: var(--correct); font-weight: bold; }
        .txt-red { color: var(--wrong); font-weight: bold; }
        
        /* Analysis Tables */
        .data-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        .data-table th, .data-table td { padding: 10px; text-align: center; border-bottom: 1px solid #eee; }
        .data-table th { background: #f8f9fa; color: #555; font-weight: 600; text-align: left; }
        .data-table td:first-child { text-align: left; font-weight: 500; }

        .score-selector {
            margin: 0 auto 20px auto; display: block; padding: 8px; 
            border: 2px solid var(--accent); border-radius: 6px; 
            font-size: 1rem; font-weight: bold; color: var(--accent);
        }

        .btn-group { display: flex; justify-content: center; gap: 10px; margin-top: 20px; }
        .btn-group button { padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; background: var(--accent); }
        
        @media (max-width: 768px) {
            .pane-passage { height: 35%; border-bottom: 2px solid #ccc; border-right: none; flex: none; }
            .sidebar-handle { display: none; }
            .pane-sidebar { position: fixed; top: 60px; right: -100%; height: calc(100dvh - 120px); z-index: 4000; width: 85%; box-shadow: -5px 0 15px rgba(0,0,0,0.2); }
            .pane-sidebar.open { right: 0; }
            .mobile-nav { display: flex; height: 60px; background: #fff; border-top: 1px solid #ccc; align-items: center; justify-content: space-around; z-index: 3000; padding-bottom: env(safe-area-inset-bottom); }
            #overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3500; }
            #overlay.active { display: block; }
            .fixed-footer { justify-content: center; flex-direction: column; gap: 10px; }
            #next-btn { display: none; }
        }
    </style>
</head>
<body>

<div id="overlay" onclick="closeSidebar()"></div>

<div id="pasteModal">
    <div class="modal-content">
        <h3>üìã Paste JSON</h3>
        <input type="text" id="pasteFileName" placeholder="Enter Filename">
        <textarea id="pasteContent" placeholder='Paste JSON here...'></textarea>
        <div class="modal-actions">
            <button onclick="closePasteModal()" style="background:#ccc; padding:8px 16px; border-radius:4px; border:none;">Cancel</button>
            <button onclick="saveAndSync()" style="background:var(--accent); color:white; padding:8px 16px; border-radius:4px; border:none;">üíæ Save & Sync</button>
        </div>
    </div>
</div>

<div id="upload-screen" class="screen active">
    <div class="container-box">
        <div class="filter-bar">
            <select id="examSelector" class="exam-select" onchange="switchExam(this.value)"></select>
            <input type="text" class="search-box" id="searchInput" placeholder="Search..." onkeyup="renderGrid()">
        </div>

        <div class="library-box">
            <div class="lib-controls">
                <h1 style="font-size:1.2rem; margin:0;">Library</h1>
                <div class="btn-row">
                    <div class="toggle-btn paste-btn" onclick="openPasteModal()">üìã Paste</div>
                    <label class="toggle-btn upload-btn">
                        üìÇ Upload <input type="file" id="jsonFile" accept=".json" multiple onchange="loadFiles(this.files)">
                    </label>
                    <div class="toggle-btn" id="multiToggle" onclick="toggleMultiSelect()">‚ùë Multi</div>
                </div>
            </div>
            
            <div id="file-grid" class="file-grid"></div>
        </div>

        <div class="history-box">
            <h3 style="text-align:center; margin-bottom:10px;">Recent Performance</h3>
            <table id="history-table" class="styled-table">
                <thead><tr><th>Test</th><th>Score</th><th>Action</th></tr></thead>
                <tbody id="history-list"></tbody>
            </table>
            <div id="no-history" style="text-align:center; color:#999; margin-top:10px;">No history found.</div>
            <div style="text-align:center; margin-top:10px;"><button class="clear" onclick="clearHistory()">Clear History</button></div>
        </div>
    </div>

    <div class="fixed-footer">
        <div class="time-row">
            <input type="number" id="hInput" class="mini-input" value="01"> <span style="font-weight:bold">:</span>
            <input type="number" id="mInput" class="mini-input" value="00"> <span style="font-weight:bold">:</span>
            <input type="number" id="sInput" class="mini-input" value="00">
        </div>
        <div>
            <button class="resume-btn" id="resume-btn" onclick="resumeExam()">RESUME</button>
            <button class="start-btn" id="start-btn" onclick="startExam()" disabled>SELECT TEST</button>
        </div>
    </div>
</div>

<div id="exam-screen" class="screen">
    <header id="main-header">
        <div class="header-title" id="exam-title">Mock Test</div>
        <div style="display:flex; align-items:center; gap:10px;">
            <div class="timer" id="timer">00:00:00</div>
            <button class="mobile-menu" onclick="openSidebar()">‚ò∞</button>
        </div>
    </header>
    
    <div class="exam-layout">
        <div id="pane-passage" class="pane-passage">
            <div style="font-weight:bold; margin-bottom:10px; color:#8a6d3b;">Reading Passage</div>
            <div id="passage-content"></div>
        </div>

        <div class="pane-question" id="touch-area">
            <div class="q-meta">
                <span><span id="q-sec">Sec</span> | <span id="q-topic">Top</span></span>
                <span>Q. <span id="q-num">1</span></span>
            </div>
            <div class="q-text" id="q-text">Loading...</div>
            <div id="options-box"></div>

            <div class="conf-box" id="conf-box">
                <strong>Confidence:</strong>
                <div class="conf-opts">
                    <div class="c-btn" onclick="setConf('100%')">100%</div>
                    <div class="c-btn" onclick="setConf('50:50')">50:50</div>
                    <div class="c-btn" onclick="setConf('Logic')">Logic</div>
                    <div class="c-btn" onclick="setConf('Guess')">Guess</div>
                </div>
            </div>

            <div style="margin-top:auto; padding-top:20px; display:flex; justify-content:space-between;">
                <button onclick="clearRes()" style="background:#e74c3c; border:none; padding:10px; color:white; border-radius:4px;">Clear</button>
                <button class="primary" style="padding:10px 20px; border-radius:4px; border:none; font-weight:bold;" onclick="nextQ()" id="next-btn">Save & Next</button>
            </div>
        </div>

        <div class="sidebar-handle" onclick="toggleSidebar()">‚ñ∂</div>

        <div id="pane-sidebar" class="pane-sidebar">
            <div style="padding:15px; background:#f9f9f9; border-bottom:1px solid #eee;">
                <button class="primary" style="width:100%; background:#27ae60; padding:10px; border:none; border-radius:4px; font-weight:bold;" onclick="submitExam()">SUBMIT TEST</button>
            </div>
            <div id="palette" class="palette-grid"></div>
        </div>
    </div>

    <div class="mobile-nav">
        <button class="mn-btn" onclick="prevQ()">‚ùÆ</button>
        <button class="mn-btn" onclick="openSidebar()">‚ñ¶</button>
        <button class="mn-btn primary" onclick="nextQ()">‚ùØ</button>
    </div>
</div>

<div id="result-screen" class="screen">
    <div class="result-container">
        <div style="text-align:center; margin-bottom:30px;">
            <h1>Analysis Report</h1>
            <p id="res-fname" style="color:#666; margin-bottom:10px;"></p>
            
            <select id="scoreSelector" class="score-selector" onchange="recalcScore()">
                <option value="initial">Original (Auto)</option>
                <option value="raw">Raw Count (+1 / 0)</option>
                <option value="sebi1">SEBI P1 (+1.25 / -0.31)</option>
                <option value="sebi2">SEBI P2 (+2.0 / -0.5)</option>
                <option value="ssc">SSC (+2.0 / -0.5)</option>
                <option value="upsc">UPSC (+2.0 / -0.66)</option>
                <option value="rbi">RBI (+1.0 / -0.25)</option>
            </select>

            <div class="btn-group">
                <button onclick="returnToLibrary()">Library</button>
                <button id="smart-review-btn" onclick="startSmartReview()" style="display:none; background:#ffc107; color:#333;">Smart Review</button>
                <button style="background:#27ae60;" onclick="downloadRes()">Download</button>
            </div>
        </div>

        <div class="score-row">
            <div class="score-card tot"><h2 id="r-score">0</h2><small>Marks</small></div>
            <div class="score-card cor"><h2 id="r-cor">0</h2><small>Correct</small></div>
            <div class="score-card wrg"><h2 id="r-wrg">0</h2><small>Wrong</small></div>
            <div class="score-card"><h2 id="r-skip">0</h2><small>Skipped</small></div>
        </div>

        <div class="analysis-section">
            <h3>Confidence Analysis</h3>
            <div style="overflow-x:auto;">
                <table id="tbl-conf" class="data-table">
                    <thead><tr><th>Type</th><th>Correct</th><th>Wrong</th><th>Total</th><th>Accuracy</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div class="analysis-section">
            <h3>Topic Analysis</h3>
            <div style="overflow-x:auto;">
                <table id="tbl-topic" class="data-table">
                    <thead><tr><th>Topic</th><th>Total</th><th>Correct</th><th>Wrong</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div class="analysis-section">
            <h3>Detailed Review</h3>
            <div id="review-list"></div>
        </div>
    </div>
</div>

<script>
    // --- CONFIG ---
    const REPO_OWNER = "Sumarpit";
    const REPO_NAME = "SEBI-Mock-Test-Tool";
    
    // --- EXAM PROFILES ---
    const EXAM_PROFILES = {
        'SEBI':   { name: 'SEBI Grade A', folder: 'tests/sebi',   marks: 1.25, neg: 0.3125, time: [1, 0, 0] },
        'RBI':    { name: 'RBI Grade B',  folder: 'tests/rbi',    marks: 1.0,  neg: 0.25,   time: [2, 0, 0] },
        'NABARD': { name: 'NABARD Gr A',  folder: 'tests/nabard', marks: 1.0,  neg: 0.25,   time: [2, 0, 0] },
        'SSC':    { name: 'SSC CGL',      folder: 'tests/ssc',    marks: 2.0,  neg: 0.50,   time: [1, 0, 0] },
        'UPSC':   { name: 'UPSC CSE',     folder: 'tests/upsc',   marks: 2.0,  neg: 0.66,   time: [2, 0, 0] }
    };

    // --- VARIABLES ---
    const BASE_KEY = 'sebi_v40_'; 
    let currentProfile = 'SEBI'; 
    let LIB_KEY = BASE_KEY + 'lib_SEBI';
    let HIST_KEY = BASE_KEY + 'hist_SEBI';

    let library = {}, cloudList = [], activeFile = '', questions = [], currIdx = 0;
    let responses = {}, confidence = {}, visited = {};
    let timer, seconds = 0, qTimers = {}, lastQTime = 0;
    let isMultiMode = false, selectedFiles = new Set();
    let isReviewMode = false, reviewSet = [];
    let initialScore = 0; 

    // --- INIT ---
    if ('launchQueue' in window) {
        window.launchQueue.setConsumer(async (launchParams) => {
            if (!launchParams.files.length) return;
            try { loadFiles([await launchParams.files[0].getFile()]); } catch (err) {}
        });
    }
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');

    window.onload = () => { 
        try { 
            const savedProfile = localStorage.getItem(BASE_KEY + 'profile');
            if (savedProfile && EXAM_PROFILES[savedProfile]) currentProfile = savedProfile;
            updateKeys();
            initExamSelector(); 
            updateTimerUI();
            loadLibraryFromStorage();
            loadFromGitHubAPI(); 
            loadHistory(); 
            checkResume(); 
            
            let touchStartX=0, touchEndX=0;
            const ta = document.getElementById('touch-area');
            ta.addEventListener('touchstart', e => touchStartX = e.changedTouches[0].screenX);
            ta.addEventListener('touchend', e => { touchEndX = e.changedTouches[0].screenX; handleSwipe(touchStartX, touchEndX); });
        } catch(e){ console.error(e); } 
    };

    function updateKeys() { LIB_KEY = BASE_KEY + 'lib_' + currentProfile; HIST_KEY = BASE_KEY + 'hist_' + currentProfile; }
    function handleSwipe(start, end) { if (start - end > 50) nextQ(); else if (end - start > 50) prevQ(); }

    // --- SWITCHER ---
    function initExamSelector() {
        const sel = document.getElementById('examSelector'); sel.innerHTML = '';
        Object.keys(EXAM_PROFILES).forEach(key => {
            const opt = document.createElement('option');
            opt.value = key; opt.innerText = EXAM_PROFILES[key].name;
            if (key === currentProfile) opt.selected = true;
            sel.appendChild(opt);
        });
    }

    function switchExam(newKey) {
        if (!EXAM_PROFILES[newKey]) return;
        if (confirm(`Switch to ${EXAM_PROFILES[newKey].name}?`)) {
            currentProfile = newKey; localStorage.setItem(BASE_KEY + 'profile', newKey);
            updateKeys();
            library = {}; cloudList = []; activeFile = ''; selectedFiles.clear();
            loadLibraryFromStorage(); loadFromGitHubAPI(); loadHistory(); renderGrid(); updateTimerUI();
            document.getElementById('start-btn').innerText = "SELECT TEST"; document.getElementById('start-btn').disabled = true;
            document.getElementById('resume-btn').style.display = 'none';
        } else { document.getElementById('examSelector').value = currentProfile; }
    }

    function updateTimerUI() {
        const time = EXAM_PROFILES[currentProfile].time;
        document.getElementById('hInput').value = time[0].toString().padStart(2, '0');
        document.getElementById('mInput').value = time[1].toString().padStart(2, '0');
        document.getElementById('sInput').value = time[2].toString().padStart(2, '0');
    }

    // --- DATA ---
    async function loadFromGitHubAPI() {
        try {
            const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${EXAM_PROFILES[currentProfile].folder}`);
            if (!res.ok) throw new Error("Empty");
            const data = await res.json();
            cloudList = data.filter(f => f.name.endsWith('.json')).map(f => ({ name: f.name, path: f.download_url, isCloud: true }));
            renderGrid();
        } catch (err) { cloudList = []; renderGrid(); }
    }

    async function fetchAndLoad(item) {
        document.getElementById('start-btn').innerText = "Loading...";
        try {
            const res = await fetch(item.path); const data = await res.json();
            library[item.name] = data; saveLibraryToStorage();
            activeFile = item.name; renderGrid();
            document.getElementById('start-btn').innerText = 'START: ' + item.name.substring(0,10);
            document.getElementById('start-btn').disabled = false;
        } catch(e) { alert("Error loading file"); }
    }

    // --- STORAGE & UI ---
    function loadLibraryFromStorage() { const s = localStorage.getItem(LIB_KEY); if(s) library = JSON.parse(s); }
    function saveLibraryToStorage() { try{localStorage.setItem(LIB_KEY, JSON.stringify(library));}catch(e){alert("Storage Full");} }
    
    function renderGrid() {
        const grid = document.getElementById('file-grid'); grid.innerHTML = '';
        const search = document.getElementById('searchInput').value.toLowerCase();
        let map = new Map();
        cloudList.forEach(i => map.set(i.name, {...i, qCount: 'Tap to Load'}));
        Object.keys(library).forEach(n => map.set(n, {name:n, source:'local', qCount: library[n].length + ' Qs'}));
        
        let list = Array.from(map.values()).filter(i => i.name.toLowerCase().includes(search)).sort((a,b)=>a.name.localeCompare(b.name));
        
        list.forEach(item => {
            const d = document.createElement('div');
            d.className = `file-card ${item.source==='cloud'?'cloud-item':''}`;
            if(item.name === activeFile) d.classList.add('active');
            if(selectedFiles.has(item.name)) d.classList.add('multi-selected');
            
            const del = item.source === 'local' ? `<div class="del-btn" onclick="deleteFile(event,'${item.name}')">√ó</div>` : '';
            d.innerHTML = `<div class="status-badge">${item.source==='local'?'üìÇ':'‚òÅÔ∏è'}</div>
                           <span class="file-name">${item.name}</span>
                           <small class="file-meta">${item.qCount}</small>${del}
                           <div class="multi-check">‚úî</div>`;
            d.onclick = async () => {
                if(isMultiMode) {
                    if(item.source==='local') {
                        if(selectedFiles.has(item.name)) selectedFiles.delete(item.name); else selectedFiles.add(item.name);
                        renderGrid(); 
                        const btn = document.getElementById('start-btn');
                        if(selectedFiles.size>0) { btn.innerText="START COMBINED"; btn.disabled=false; } else { btn.innerText="SELECT"; btn.disabled=true; }
                    }
                } else {
                    if(item.source==='local') { activeFile = item.name; document.getElementById('start-btn').innerText = 'START: '+item.name.substring(0,10); document.getElementById('start-btn').disabled = false; renderGrid(); }
                    else await fetchAndLoad(item);
                }
            };
            grid.appendChild(d);
        });
        if(list.length===0) grid.innerHTML = '<div style="color:#999; text-align:center; padding:20px;">No tests found.</div>';
    }

    function deleteFile(e, name) {
        e.stopPropagation();
        if(confirm(`Delete ${name}?`)) {
            delete library[name]; saveLibraryToStorage();
            if(activeFile===name) { activeFile=''; document.getElementById('start-btn').disabled=true; }
            renderGrid();
        }
    }

    function toggleMultiSelect() {
        isMultiMode = !isMultiMode; selectedFiles.clear();
        document.getElementById('multiToggle').classList.toggle('active');
        renderGrid(); document.getElementById('start-btn').disabled=true;
    }

    // --- PASTE ---
    function openPasteModal() { document.getElementById('pasteModal').style.display='flex'; }
    function closePasteModal() { document.getElementById('pasteModal').style.display='none'; }
    async function saveAndSync() {
        const name = document.getElementById('pasteFileName').value.trim();
        const content = document.getElementById('pasteContent').value.trim();
        if(!name || !content) return;
        try {
            const parsed = JSON.parse(content);
            const fname = name.endsWith('.json')?name:name+'.json';
            library[fname] = parsed; saveLibraryToStorage();
            activeFile = fname; renderGrid();
            document.getElementById('start-btn').innerText='START: '+fname.substring(0,10);
            document.getElementById('start-btn').disabled=false;
            await navigator.clipboard.writeText(content);
            window.open(`https://github.com/${REPO_OWNER}/${REPO_NAME}/issues/new?title=${encodeURIComponent(fname)}&labels=new-test`, '_blank');
            closePasteModal();
        } catch(e){ alert("Invalid JSON"); }
    }

    function loadFiles(files) {
        if(!files.length) return;
        Array.from(files).forEach(f => {
            const r = new FileReader();
            r.onload = e => { 
                try { library[f.name] = JSON.parse(e.target.result); saveLibraryToStorage(); renderGrid(); } 
                catch(x){ alert('Invalid JSON'); }
            };
            r.readAsText(f);
        });
    }

    // --- EXAM LOGIC ---
    function prepareQuestions(list) {
        let groups = [], cur = [];
        list.forEach((q, i) => {
            if(i===0) cur.push(q);
            else {
                const prev = list[i-1];
                const sameP = q.passage && prev.passage && q.passage.trim()===prev.passage.trim();
                const sameG = q.group_id && prev.group_id && q.group_id===prev.group_id;
                if(sameP || sameG) cur.push(q); else { groups.push(cur); cur=[q]; }
            }
        });
        if(cur.length>0) groups.push(cur);
        for(let i=groups.length-1; i>0; i--) { const j=Math.floor(Math.random()*(i+1)); [groups[i], groups[j]] = [groups[j], groups[i]]; }
        return groups.flat().map(q => {
            let nq = JSON.parse(JSON.stringify(q));
            const fixed = ["Both","All of","None of","Only A"].some(x => nq.options.some(o => o.includes(x)));
            if(nq.noShuffle!==true && !fixed) {
                let ansTxt = nq.options[nq.answer];
                for(let i=nq.options.length-1; i>0; i--) { const j=Math.floor(Math.random()*(i+1)); [nq.options[i], nq.options[j]] = [nq.options[j], nq.options[i]]; }
                nq.answer = nq.options.indexOf(ansTxt);
            }
            return nq;
        });
    }

    function startExam() {
        if(localStorage.getItem(BASE_KEY+'resume_'+currentProfile)) if(!confirm("Discard current progress?")) return;
        isReviewMode = false;
        let raw = [];
        if(isMultiMode) selectedFiles.forEach(f => { if(library[f]) raw.push(...library[f]); });
        else { if(!library[activeFile]) return; raw = library[activeFile]; }
        
        questions = prepareQuestions(raw);
        responses = {}; confidence = {}; visited = {}; qTimers = {}; currIdx = 0; lastQTime = 0;
        const h = parseInt(document.getElementById('hInput').value)||0;
        const m = parseInt(document.getElementById('mInput').value)||0;
        const s = parseInt(document.getElementById('sInput').value)||0;
        seconds = h*3600 + m*60 + s || 3600;
        initExamUI();
    }

    function initExamUI() {
        document.getElementById('upload-screen').classList.remove('active');
        document.getElementById('result-screen').classList.remove('active');
        document.getElementById('exam-screen').classList.add('active');
        const hdr = document.getElementById('main-header');
        const tmr = document.getElementById('timer');
        if(isReviewMode) { hdr.classList.add('review-mode'); tmr.classList.add('review-timer'); }
        else { hdr.classList.remove('review-mode'); tmr.classList.remove('review-timer'); }
        questions.forEach((_,i)=>visited[i]=false);
        startTimer(); loadQ(0); saveState();
    }

    function loadQ(i) {
        if(lastQTime!==0) qTimers[currIdx] = (qTimers[currIdx]||0) + (Date.now()-lastQTime)/1000;
        lastQTime = Date.now(); currIdx = i; visited[i] = true;
        
        const q = questions[i];
        const pass = document.getElementById('pane-passage');
        if(q.passage) { pass.classList.add('active'); document.getElementById('passage-content').innerHTML=q.passage; }
        else pass.classList.remove('active');
        
        document.getElementById('q-num').innerText = i+1;
        document.getElementById('q-sec').innerText = q.section || '-';
        document.getElementById('q-topic').innerText = q.topic || '-';
        document.getElementById('q-text').innerHTML = q.question;
        
        const box = document.getElementById('options-box'); box.innerHTML='';
        q.options.forEach((o, idx) => {
            const d = document.createElement('div'); d.className='opt-label';
            if(responses[i]===idx) d.classList.add('selected');
            d.innerHTML = `<input type="radio" ${responses[i]===idx?'checked':''}> ${o}`;
            d.onclick = () => { responses[i]=idx; loadQ(i); saveState(); };
            box.appendChild(d);
        });

        // FIXED: Confidence buttons now check exact text
        const cf = document.querySelectorAll('.c-btn');
        if(responses[i]!==undefined) {
            document.getElementById('conf-box').classList.add('active');
            cf.forEach(b => { 
                b.classList.remove('sel'); 
                if(b.innerText === confidence[i]) b.classList.add('sel'); 
            });
        } else { document.getElementById('conf-box').classList.remove('active'); cf.forEach(b=>b.classList.remove('sel')); }

        const btn = document.getElementById('next-btn');
        if(i===questions.length-1) { btn.innerText="Submit Test"; btn.style.background="#e67e22"; }
        else { btn.innerText="Save & Next"; btn.style.background="#2962ff"; }
        renderPalette(); saveState();
    }

    function setConf(v) { confidence[currIdx]=v; saveState(); loadQ(currIdx); }
    function clearRes() { delete responses[currIdx]; delete confidence[currIdx]; saveState(); loadQ(currIdx); }
    function nextQ() { if(currIdx<questions.length-1) loadQ(currIdx+1); else submitExam(); }
    function prevQ() { if(currIdx>0) loadQ(currIdx-1); }
    function renderPalette() {
        const p = document.getElementById('palette'); p.innerHTML='';
        questions.forEach((_, i) => {
            const b = document.createElement('div'); b.className='pal-btn'; b.innerText=i+1;
            if(i===currIdx) b.classList.add('current');
            if(responses[i]!==undefined) b.classList.add('ans'); else if(visited[i]) b.classList.add('visit');
            b.onclick = () => { loadQ(i); if(window.innerWidth<=768) closeSidebar(); };
            p.appendChild(b);
        });
    }
    function toggleSidebar() { const s=document.getElementById('pane-sidebar'); s.classList.toggle('collapsed'); document.querySelector('.sidebar-handle').innerText=s.classList.contains('collapsed')?'‚óÄ':'‚ñ∂'; }
    function openSidebar() { document.getElementById('pane-sidebar').classList.add('open'); document.getElementById('overlay').classList.add('active'); }
    function closeSidebar() { document.getElementById('pane-sidebar').classList.remove('open'); document.getElementById('overlay').classList.remove('active'); }

    function startTimer() {
        clearInterval(timer);
        timer = setInterval(() => {
            if(isReviewMode) seconds++; else { seconds--; if(seconds<=0) submitExam(true); }
            const h = Math.floor(seconds/3600).toString().padStart(2,'0');
            const m = Math.floor((seconds%3600)/60).toString().padStart(2,'0');
            const s = (seconds%60).toString().padStart(2,'0');
            document.getElementById('timer').innerText = `${h}:${m}:${s}`;
            if(!isReviewMode) document.getElementById('timer').classList.toggle('critical', seconds<60);
        }, 1000);
    }

    function saveState() { localStorage.setItem(BASE_KEY+'resume_'+currentProfile, JSON.stringify({library, activeFile, questions, responses, confidence, visited, currIdx, seconds, isReviewMode, qTimers, lastQTime})); }
    function checkResume() { if(localStorage.getItem(BASE_KEY+'resume_'+currentProfile)) document.getElementById('resume-btn').style.display='inline-block'; }
    function resumeExam() {
        const d = JSON.parse(localStorage.getItem(BASE_KEY+'resume_'+currentProfile));
        loadLibraryFromStorage(); activeFile=d.activeFile; questions=d.questions; responses=d.responses; confidence=d.confidence; visited=d.visited; currIdx=d.currIdx; seconds=d.seconds; isReviewMode=d.isReviewMode; qTimers=d.qTimers||{}; lastQTime=Date.now();
        initExamUI();
    }

    function submitExam(force=false) {
        if(!force && !confirm("End Exam?")) return;
        clearInterval(timer);
        if(lastQTime!==0) qTimers[currIdx] = (qTimers[currIdx]||0) + (Date.now()-lastQTime)/1000;
        localStorage.removeItem(BASE_KEY+'resume_'+currentProfile);

        let score=0, cor=0, wrg=0, skip=0;
        // RESTORED: Stats Objects for Tables
        let tStats={}, cStats={ '100%':{c:0,w:0}, '50:50':{c:0,w:0}, 'Logic':{c:0,w:0}, 'Guess':{c:0,w:0} };
        reviewSet = [];
        
        questions.forEach((q, i) => {
            const ans = responses[i]; const conf = confidence[i];
            
            // Topic Logic
            const top = q.topic || 'Unknown';
            if(!tStats[top]) tStats[top] = {t:0, c:0, w:0}; 
            tStats[top].t++;

            let qMark = q.marks ? parseFloat(q.marks) : EXAM_PROFILES[currentProfile].marks;
            let qNeg = q.negative ? parseFloat(q.negative) : (q.marks ? parseFloat(q.marks)*0.25 : EXAM_PROFILES[currentProfile].neg);
            
            if(ans === undefined) { skip++; reviewSet.push(q); }
            else if(ans === q.answer) { 
                score += qMark; cor++; 
                tStats[top].c++;
                if(conf && cStats[conf]) cStats[conf].c++;
            }
            else { 
                score -= qNeg; wrg++; 
                tStats[top].w++;
                if(conf && cStats[conf]) cStats[conf].w++;
                reviewSet.push(q); 
            }
        });

        initialScore = score; 

        // Save History
        if(!isReviewMode) {
            const dur = parseInt(document.getElementById('hInput').value)*3600 + parseInt(document.getElementById('mInput').value)*60 + parseInt(document.getElementById('sInput').value);
            let h = JSON.parse(localStorage.getItem(HIST_KEY)||'[]');
            h.unshift({name:activeFile, score:score.toFixed(2), date:new Date().toLocaleDateString(), dur: dur});
            localStorage.setItem(HIST_KEY, JSON.stringify(h));
        }

        document.getElementById('exam-screen').classList.remove('active');
        document.getElementById('result-screen').classList.add('active');
        
        document.getElementById('res-fname').innerText = activeFile.replace(/\.json$/i, '');
        document.getElementById('scoreSelector').value = 'initial'; 
        
        updateResultCards(score, cor, wrg, skip);
        
        // RESTORED: POPULATE TABLES
        const tConf = document.getElementById('tbl-conf').querySelector('tbody'); tConf.innerHTML='';
        Object.keys(cStats).forEach(k => {
            const d = cStats[k], tot = d.c+d.w;
            if(tot > 0) { // Only show used confidence levels
                tConf.innerHTML += `<tr><td>${k}</td><td class="txt-green">${d.c}</td><td class="txt-red">${d.w}</td><td>${tot}</td><td>${Math.round((d.c/tot)*100)}%</td></tr>`;
            }
        });

        const tTopic = document.getElementById('tbl-topic').querySelector('tbody'); tTopic.innerHTML='';
        Object.keys(tStats).forEach(k => {
            const d = tStats[k];
            tTopic.innerHTML += `<tr><td>${k}</td><td>${d.t}</td><td class="txt-green">${d.c}</td><td class="txt-red">${d.w}</td></tr>`;
        });

        const rb = document.getElementById('smart-review-btn');
        if(reviewSet.length>0) { rb.style.display='inline-block'; } else rb.style.display='none';

        const rev = document.getElementById('review-list'); rev.innerHTML = '';
        questions.forEach((q, i) => {
            const ans = responses[i]; const conf = confidence[i]||'';
            const t = Math.round(qTimers[i]||0);
            const ts = t>60 ? Math.floor(t/60)+'m '+(t%60)+'s' : t+'s';
            
            let status = 'Skipped', cls = 'skip', uAns = 'Skipped';
            if(ans !== undefined) {
                if(ans === q.answer) { status='Correct'; cls='correct'; uAns=q.options[ans]; }
                else { status='Wrong'; cls='wrong'; uAns=q.options[ans]; }
            }
            
            rev.innerHTML += `
            <div class="review-item ${cls}">
                <div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding-bottom:5px; margin-bottom:5px;">
                    <strong>Q${i+1} (${status})</strong>
                    <div style="font-size:0.8rem; color:#666;">‚è± ${ts} ${conf?`| ${conf}`:''}</div>
                </div>
                <div style="margin-bottom:10px;">${q.question}</div>
                <div style="font-size:0.9rem;">You: <b>${uAns}</b> <br> Ans: <span class="txt-green">${q.options[q.answer]}</span></div>
                <div style="background:#f9f9f9; padding:8px; margin-top:10px; font-size:0.9rem;">Exp: ${q.explanation}</div>
            </div>`;
        });
    }

    function recalcScore() {
        const type = document.getElementById('scoreSelector').value;
        const cor = parseInt(document.getElementById('r-cor').innerText);
        const wrg = parseInt(document.getElementById('r-wrg').innerText);
        let newScore = 0;
        if (type === 'initial') newScore = initialScore;
        else if (type === 'raw') newScore = cor * 1;
        else {
            const schemes = { 'sebi1': { p: 1.25, n: 0.3125 }, 'sebi2': { p: 2.0, n: 0.5 }, 'ssc': { p: 2.0, n: 0.5 }, 'upsc': { p: 2.0, n: 0.66 }, 'rbi': { p: 1.0, n: 0.25 } };
            const s = schemes[type];
            if(s) newScore = (cor * s.p) - (wrg * s.n);
        }
        document.getElementById('r-score').innerText = newScore.toFixed(2);
    }

    function updateResultCards(s, c, w, k) {
        document.getElementById('r-score').innerText = s.toFixed(2);
        document.getElementById('r-cor').innerText = c;
        document.getElementById('r-wrg').innerText = w;
        document.getElementById('r-skip').innerText = k;
    }

    function startSmartReview() {
        if(!reviewSet.length) return;
        if(confirm("Start Review?")) {
            isReviewMode = true; questions = prepareQuestions(reviewSet);
            activeFile += " (Review)"; responses={}; confidence={}; visited={}; currIdx=0; seconds=0; qTimers={};
            initExamUI();
        }
    }

    function loadHistory() {
        const h = JSON.parse(localStorage.getItem(HIST_KEY)||'[]');
        const l = document.getElementById('history-list'); l.innerHTML='';
        if(h.length) {
            document.getElementById('no-history').style.display='none';
            h.slice(0,10).forEach(x => {
                l.innerHTML += `<tr><td>${x.name.substring(0,20)}<br><small>${x.date}</small></td><td><b>${x.score}</b></td><td><button class="retake" onclick="retakeTest('${x.name}', ${x.dur})">Retake</button></td></tr>`;
            });
        }
    }
    function clearHistory() { localStorage.removeItem(HIST_KEY); loadHistory(); }
    function retakeTest(n, d) {
        if(!library[n]) { alert("Missing file"); return; }
        if(!confirm("Retake?")) return;
        isReviewMode=false; questions=prepareQuestions(library[n]); activeFile=n;
        seconds=d; responses={}; confidence={}; visited={}; qTimers={}; currIdx=0;
        localStorage.removeItem(BASE_KEY+'resume_'+currentProfile);
        initExamUI();
    }
    function returnToLibrary() { document.getElementById('result-screen').classList.remove('active'); document.getElementById('upload-screen').classList.add('active'); renderGrid(); loadHistory(); }
    function downloadRes() {
        const html = document.getElementById('result-screen').innerHTML;
        const css = document.getElementsByTagName('style')[0].innerText;
        const blob = new Blob([`<html><head><style>${css} body{overflow:visible;} #result-screen{display:block!important;}</style></head><body><div id="result-screen">${html}</div></body></html>`], {type:'text/html'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Result.html`; a.click();
    }
</script>
</body>
</html>
