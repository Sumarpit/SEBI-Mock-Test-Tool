<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SEBI Grade A Tool (v40)</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root {
            --header-bg: #1a237e;
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --text-color: #333;
            --accent: #2962ff;
            --correct: #2ecc71;
            --wrong: #e74c3c;
            --cloud: #00bcd4;
            --footer-height: 80px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        
        body { 
            height: 100dvh; width: 100vw; overflow: hidden; 
            background: var(--bg-color); display: flex; flex-direction: column;
        }

        /* --- SCREENS --- */
        .screen { display: none; height: 100%; width: 100%; flex-direction: column; }
        #upload-screen.active, #result-screen.active { display: block; overflow-y: auto; }
        #exam-screen.active { display: flex; } 

        /* --- 1. UPLOAD SCREEN & LIBRARY --- */
        .container-box { max-width: 900px; margin: 20px auto; padding: 0 20px 160px 20px; }
        
        .filter-bar { margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .search-box { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; margin-bottom: 10px; }
        
        /* Tabs Hidden as requested */
        .tabs { display: none; gap: 10px; }

        .library-box { background: var(--card-bg); padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); text-align: center; margin-bottom: 20px; }
        
        .lib-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap:10px; }
        .toggle-btn { background: #eee; color: #333; padding: 6px 12px; border-radius: 20px; cursor: pointer; border: 1px solid #ccc; font-size: 0.85rem; display: flex; align-items: center; gap: 5px; }
        .toggle-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
        .paste-btn { background: #e3f2fd; color: var(--accent); border: 1px solid var(--accent); font-weight: bold; }

        .drop-zone { border: 2px dashed #ccc; background: #fafafa; cursor: pointer; border-radius: 6px; transition: 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; margin-bottom: 20px; }
        .drop-zone:hover { border-color: var(--accent); background: #f0f8ff; }
        input[type="file"] { display: none; }

        /* --- LIST VIEW STYLES (UPDATED) --- */
        .file-grid { 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
            margin-top: 10px; 
        }

        .file-card { 
            background: #fff; 
            border: 1px solid #eee; 
            padding: 12px 15px; 
            border-radius: 6px; 
            cursor: pointer; 
            transition: 0.2s; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); 
            text-align: left; 
            min-height: 50px;
            display: flex; 
            flex-direction: row; 
            align-items: center; 
            position: relative; 
            overflow: hidden; 
        }

        .file-card:hover { background-color: #f8f9fa; border-color: var(--accent); }
        .file-card.active { border: 1px solid var(--accent); background: #e3f2fd; }
        
        .status-badge { font-size: 1.2rem; margin-right: 15px; width: 25px; text-align: center; }
        
        .file-name { 
            font-weight: 600; font-size: 0.95rem; color: #333; margin-bottom: 0;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
            flex: 1; padding-right: 10px; 
        }
        
        .file-meta { font-size: 0.85rem; color: #888; white-space: nowrap; min-width: 60px; text-align: right; }

        .file-card.multi-selected { border: 1px solid var(--accent); background: #e3f2fd; }
        .multi-check { 
            margin-left: 10px; background: var(--accent); color: white; 
            border-radius: 50%; width: 22px; height: 22px; 
            display: none; align-items: center; justify-content: center; font-size: 0.7rem; 
        }
        .file-card.multi-selected .multi-check { display: flex; }


        /* --- MODAL --- */
        #pasteModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 5000; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 500px; display: flex; flex-direction: column; gap: 10px; }
        .modal-content h3 { margin: 0 0 10px 0; color: var(--accent); }
        .modal-content textarea { width: 100%; height: 200px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-family: monospace; resize: none; }
        .modal-content input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        .modal-actions { display: flex; justify-content: space-between; margin-top: 10px; }
        .modal-group-right { display: flex; gap: 10px; }

        /* --- STICKY FOOTER --- */
        .fixed-footer {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: #fff; border-top: 1px solid #ccc; padding: 15px 20px;
            display: grid; grid-template-columns: 1.1fr 1fr; gap: 15px;
            align-items: center; box-shadow: 0 -4px 15px rgba(0,0,0,0.15);
            z-index: 2000; padding-bottom: calc(15px + env(safe-area-inset-bottom));
        }

        .footer-left { display: flex; flex-direction: column; gap: 8px; }
        .radio-group { display: flex; gap: 10px; background: #e3f2fd; padding: 8px; border-radius: 6px; border: 1px solid var(--accent); justify-content: space-around; }
        .radio-item { display: flex; align-items: center; gap: 5px; font-size: 0.85rem; font-weight: bold; cursor: pointer; color: var(--accent); }
        .radio-item input { accent-color: var(--accent); width: 16px; height: 16px; cursor: pointer; }

        .time-row { display: flex; align-items: center; gap: 5px; justify-content: flex-start; }
        .mini-input { width: 65px; padding: 10px 5px; text-align: center; border: 2px solid #ddd; border-radius: 8px; font-size: 1.3rem; font-weight: bold; color: #333; background: #fff; }
        .mini-input:focus { border-color: var(--accent); outline: none; }
        .colon { font-weight: bold; color: #888; font-size: 1.2rem; }

        .footer-right { display: flex; justify-content: flex-end; }
        .start-btn { width: 100%; height: 60px; background: var(--accent); color: white; font-weight: bold; border: none; border-radius: 8px; font-size: 1.1rem; cursor: pointer; text-transform: uppercase; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .start-btn:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; }
        .resume-btn { width: 100%; height: 60px; background: #f39c12; color: white; border: none; border-radius: 8px; font-weight: bold; display: none; font-size: 1.1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        /* General Styles */
        .history-box { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #f8f9fa; color: #666; font-weight: 600; }
        button.clear { background: transparent; color: #e74c3c; text-decoration: underline; margin-top: 10px; padding: 0; border: none; cursor:pointer;}
        button.retake { background: #27ae60; padding: 6px 12px; font-size: 0.8rem; color: white; border:none; border-radius:4px; cursor:pointer;}
        
        header { height: 60px; background: var(--header-bg); color: white; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; width: 100%; flex-shrink: 0; z-index: 3000; box-shadow: 0 2px 10px rgba(0,0,0,0.2); padding-top: env(safe-area-inset-top); }
        header.review-mode { background: #343a40; border-bottom: 3px solid #ffc107; }
        .header-title { font-size: 1.1rem; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 60%; }
        .timer { font-weight: bold; background: #222; color: #00ff00; padding: 5px 10px; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 1.1rem; border: 1px solid #444; }
        .timer.critical { background: #e74c3c; color: white; animation: pulse 1s infinite; }
        .timer.review-timer { color: #ffc107; border-color: #ffc107; }
        
        .exam-layout { display: flex; flex: 1; width: 100%; overflow: hidden; background: #e9ecef; position: relative; }
        .pane-passage { flex: 1; background: #fffbf2; padding: 25px; overflow-y: auto; border-right: 1px solid #ddd; font-family: Georgia, serif; line-height: 1.6; display: none; }
        .pane-passage.active { display: block; }
        .pane-question { flex: 1.2; background: #fff; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; min-width: 300px; }
        .q-meta { font-size: 0.85rem; color: #777; margin-bottom: 10px; display: flex; justify-content: space-between; font-weight: bold; border-bottom: 1px solid #f0f0f0; padding-bottom: 8px; }
        .q-text { font-size: 1.15rem; margin-bottom: 20px; line-height: 1.5; font-weight: 500; }
        .opt-label { display: flex; align-items: flex-start; padding: 12px; border: 1px solid #eee; margin-bottom: 10px; border-radius: 6px; cursor: pointer; transition: 0.2s; }
        .opt-label.selected { background: #e3f2fd; border-color: var(--accent); box-shadow: inset 0 0 0 1px var(--accent); }
        .opt-label input { margin-right: 12px; margin-top: 4px; }
        
        .sidebar-handle { width: 15px; background: #dcdcdc; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; color: #555; z-index: 10; border-left: 1px solid #ccc; }
        .pane-sidebar { width: 300px; background: #fff; display: flex; flex-direction: column; transition: width 0.3s ease; flex-shrink: 0; }
        .pane-sidebar.collapsed { width: 0; border: none; overflow: hidden; }
        .palette-grid { flex: 1; overflow-y: auto; padding: 15px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; align-content: start; }
        .pal-btn { height: 35px; border: 1px solid #ddd; background: #fff; cursor: pointer; border-radius: 4px; font-weight: bold; display: flex; align-items: center; justify-content: center; }
        .pal-btn.ans { background: var(--correct); color: white; border: none; }
        .pal-btn.visit { background: #e74c3c; color: white; border: none; }
        .pal-btn.current { border: 2px solid #333; }
        
        .conf-box { margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px; opacity: 0.5; pointer-events: none; }
        .conf-box.active { opacity: 1; pointer-events: auto; background: #e3f2fd; }
        .conf-opts { display: flex; gap: 5px; margin-top: 10px; }
        .c-btn { flex: 1; padding: 6px; font-size: 0.8rem; border: 1px solid #ccc; background: white; border-radius: 4px; cursor: pointer; text-align: center; }
        .c-btn.sel { background: #673ab7; color: white; border-color: #5e35b1; }

        .mobile-nav { display: none; height: 60px; background: #fff; border-top: 1px solid #ccc; align-items: center; justify-content: space-around; flex-shrink: 0; z-index: 3000; padding-bottom: env(safe-area-inset-bottom); }
        .mn-btn { background: transparent; color: #555; font-size: 1.2rem; padding: 10px; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; }
        .mn-btn.primary { color: var(--accent); font-weight: bold; font-size: 1.5rem; }
        .mobile-menu { display: none; background: transparent; font-size: 1.5rem; margin-left: 10px; border:none; color: white;}
        
        /* RESULTS */
        .result-container { max-width: 850px; margin: 40px auto; padding-bottom: 50px; }
        .btn-group { display: flex; justify-content: center; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        .btn-group button { padding: 12px 20px; font-size: 1rem; border-radius: 6px; cursor: pointer; border: none; font-weight: bold; flex: 1; min-width: 150px; max-width: 250px; display: flex; align-items: center; justify-content: center; }
        
        .score-row { display: flex; justify-content: center; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; }
        .score-card { background: white; padding: 20px; border-radius: 8px; width: 150px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-top: 4px solid #ccc; }
        .score-card.tot { border-color: var(--accent); }
        .score-card.cor { border-color: var(--correct); }
        .score-card.wrg { border-color: var(--wrong); }
        .analysis-section { background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); padding: 20px; margin-bottom: 25px; }
        .review-item { background: white; border-left: 5px solid #ccc; padding: 15px; margin-bottom: 15px; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); position: relative; }
        .review-item.correct { border-left-color: var(--correct); }
        .review-item.wrong { border-left-color: var(--wrong); }
        .txt-green { color: var(--correct); font-weight: bold; }
        .txt-red { color: var(--wrong); font-weight: bold; }

        button.primary { background: var(--accent); color: white; }
        button.review { background: #ffc107; color: #333; }

        @media (max-width: 768px) {
            .pane-passage { height: 35%; border-bottom: 2px solid #ccc; border-right: none; flex: none; }
            .sidebar-handle { display: none; }
            .pane-sidebar { position: fixed; top: 60px; right: -100%; height: calc(100dvh - 120px); z-index: 4000; width: 85%; box-shadow: -5px 0 15px rgba(0,0,0,0.2); }
            .pane-sidebar.open { right: 0; }
            .mobile-nav { display: flex; }
            #overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3500; }
            #overlay.active { display: block; }
            #next-btn { display: none; } 
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div id="overlay" onclick="closeSidebar()"></div>

<div id="pasteModal">
    <div class="modal-content">
        <h3>üìã Paste JSON Code</h3>
        <input type="text" id="pasteFileName" placeholder="Enter Filename (e.g. My_Test)">
        <textarea id="pasteContent" placeholder='Paste your JSON here... Example: [{"question":"...", "options":[...], "answer":0}]'></textarea>
        <div class="modal-actions">
            <button onclick="closePasteModal()" style="background:#ccc; border:none; padding:8px 16px; border-radius:4px; cursor:pointer; color:#333; font-weight:bold;">Cancel</button>
            <button onclick="saveAndSync()" style="background:var(--accent); color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer; font-weight:bold; flex:1; margin-left:10px;">
            üíæ Save JSON & Sync
            </button>
        </div>
        <small style="color:#777; margin-top:5px; font-size:0.8rem;">* "Save to Cloud" will copy the code and open a GitHub Issue.</small>
    </div>
</div>

<div id="upload-screen" class="screen active">
    <div class="container-box">
        
        <div class="filter-bar">
            <input type="text" class="search-box" id="searchInput" placeholder="üîç Search SEBI Mock Tests..." onkeyup="renderGrid()">
        </div>

        <div class="library-box">
            <div class="lib-controls">
                <h1 style="font-size:1.2rem;">SEBI Grade A Library</h1>
                <div style="display:flex; gap:10px;">
                    <div class="toggle-btn paste-btn" onclick="openPasteModal()">
                        <span class="icon">üìã</span> Paste JSON
                    </div>
                    <div class="toggle-btn" id="multiToggle" onclick="toggleMultiSelect()">
                        <span class="icon">‚ùë</span> Select Multiple
                    </div>
                </div>
            </div>
            
            <label class="drop-zone" id="dropZone">
                <p>üìÇ Upload Local JSON</p>
                <input type="file" id="jsonFile" accept=".json" multiple>
            </label>
            
            <div id="file-grid" class="file-grid"></div>
        </div>

        <div class="history-box">
            <h3 style="text-align:center; margin-bottom:15px;">Recent Performance</h3>
            <table id="history-table">
                <thead><tr><th>Test</th><th>Score</th><th>Action</th></tr></thead>
                <tbody id="history-list"></tbody>
            </table>
            <div id="no-history" style="text-align:center; color:#999; margin-top:10px;">No history found.</div>
            <div style="text-align:center;"><button class="clear" onclick="clearHistory()">Clear History</button></div>
        </div>
    </div>

    <div class="fixed-footer">
        <div class="footer-left">
            <div class="radio-group">
                <label class="radio-item"><input type="radio" name="pMode" value="auto" checked> Auto</label>
                <label class="radio-item"><input type="radio" name="pMode" value="1"> P1(+1.25)</label>
                <label class="radio-item"><input type="radio" name="pMode" value="2"> P2(+2)</label>
            </div>
            <div class="time-row">
                <input type="number" id="hInput" class="mini-input" value="01" min="0">
                <span class="colon">:</span>
                <input type="number" id="mInput" class="mini-input" value="00" min="0" max="59">
                <span class="colon">:</span>
                <input type="number" id="sInput" class="mini-input" value="00" min="0" max="59">
            </div>
        </div>
        <div class="footer-right">
            <button class="resume-btn" id="resume-btn" onclick="resumeExam()">RESUME</button>
            <button class="start-btn" id="start-btn" onclick="startExam()" disabled>SELECT TEST</button>
        </div>
    </div>
</div>

<div id="exam-screen" class="screen">
    <header id="main-header">
        <div class="header-title" id="exam-title">SEBI Grade A Mock Test</div>
        <div class="header-controls">
            <div class="timer" id="timer">00:00:00</div>
            <button class="mobile-menu" onclick="openSidebar()">‚ò∞</button>
        </div>
    </header>
    
    <div class="exam-layout">
        <div id="pane-passage" class="pane-passage">
            <div style="font-weight:bold; text-decoration:underline; margin-bottom:10px; color:#8a6d3b;">Reading Comprehension</div>
            <div id="passage-content"></div>
        </div>

        <div class="pane-question" id="touch-area">
            <div class="q-meta">
                <span><span id="q-sec">Sec</span> | <span id="q-topic">Top</span></span>
                <span>Q. <span id="q-num">1</span></span>
            </div>
            <div class="q-text" id="q-text">Loading...</div>
            <div id="options-box"></div>

            <div class="conf-box" id="conf-box">
                <strong>Confidence Level:</strong>
                <div class="conf-opts">
                    <div class="c-btn" onclick="setConf('100% Sure')">100% Sure</div>
                    <div class="c-btn" onclick="setConf('50:50')">50:50</div>
                    <div class="c-btn" onclick="setConf('Logical')">Logical</div>
                    <div class="c-btn" onclick="setConf('Guess')">Guess</div>
                </div>
            </div>

            <div style="margin-top:auto; padding-top:20px; display:flex; justify-content:space-between;">
                <button onclick="clearRes()" style="background:#e74c3c; border:none; padding:10px; color:white; border-radius:4px;">Clear</button>
                <button class="primary" onclick="nextQ()" id="next-btn">Save & Next</button>
            </div>
        </div>

        <div class="sidebar-handle" onclick="toggleSidebar()">‚ñ∂</div>

        <div id="pane-sidebar" class="pane-sidebar">
            <div style="padding:15px; background:#f9f9f9; border-bottom:1px solid #eee;">
                <button class="primary" style="width:100%; background:#27ae60;" onclick="submitExam()">SUBMIT TEST</button>
            </div>
            <div style="padding:10px; font-size:0.8rem; display:flex; gap:10px; flex-wrap:wrap; border-bottom:1px solid #eee;">
                <span style="color:var(--correct)">‚óè Ans</span> <span style="color:#e74c3c">‚óè Unans</span> <span style="border:1px solid #ccc; width:10px; height:10px; display:inline-block;"></span> Visit
            </div>
            <div id="palette" class="palette-grid"></div>
        </div>
    </div>

    <div class="mobile-nav">
        <button class="mn-btn" onclick="prevQ()">‚ùÆ</button>
        <button class="mn-btn" onclick="openSidebar()">‚ñ¶</button>
        <button class="mn-btn primary" onclick="nextQ()">‚ùØ</button>
    </div>
</div>

<div id="result-screen" class="screen">
    <div class="result-container">
        <div style="text-align:center; margin-bottom:30px;">
            <h1>Analysis Report</h1>
            <p id="res-fname" style="color:#666; margin-bottom:5px;"></p>
            <p id="res-mode" style="color:var(--accent); font-weight:bold; font-size:0.9rem; margin-bottom:15px;"></p>
            
            <div class="btn-group">
                <button class="primary" onclick="returnToLibrary()">Back to Library</button>
                <button class="review" id="smart-review-btn" onclick="startSmartReview()" style="display:none;">Smart Review</button>
                <button class="primary" style="background:#27ae60;" onclick="downloadRes()">Download HTML</button>
            </div>
        </div>

        <div class="score-row">
            <div class="score-card tot"><h2 id="r-score">0</h2><small>Marks</small></div>
            <div class="score-card cor"><h2 id="r-cor">0</h2><small>Correct</small></div>
            <div class="score-card wrg"><h2 id="r-wrg">0</h2><small>Wrong</small></div>
            <div class="score-card"><h2 id="r-skip">0</h2><small>Skipped</small></div>
        </div>

        <div class="analysis-section">
            <h3>Confidence Analysis</h3>
            <div style="overflow-x:auto;">
                <table id="tbl-conf"><thead><tr><th>Type</th><th>Correct</th><th>Wrong</th><th>Total</th><th>Accuracy</th></tr></thead><tbody></tbody></table>
            </div>
        </div>

        <div class="analysis-section">
            <h3>Topic Analysis</h3>
            <div style="overflow-x:auto;">
                <table id="tbl-topic"><thead><tr><th>Topic</th><th>Total</th><th>Correct</th><th>Wrong</th></tr></thead><tbody></tbody></table>
            </div>
        </div>

        <div class="analysis-section">
            <h3>Detailed Review</h3>
            <div id="review-list"></div>
        </div>
    </div>
</div>

<script>
    // --- USER CONFIG ---
    const REPO_OWNER = "Sumarpit";
    const REPO_NAME = "SEBI-Mock-Test-Tool";
    
    // --- VARIABLES ---
    const KEY = 'sebi_v1_data';
    const HIST = 'sebi_v1_hist';
    const LIB_KEY = 'sebi_v1_library';
    
    let library = {}, cloudList = [], activeFile = '', questions = [], currIdx = 0;
    let responses = {}, confidence = {}, visited = {};
    let timer, seconds = 0;
    let isMultiMode = false, selectedFiles = new Set();
    let isReviewMode = false, reviewSet = [];
    
    // NEW: Timer Variables
    let qTimers = {}; 
    let lastQTime = 0;

    if ('launchQueue' in window) {
        window.launchQueue.setConsumer(async (launchParams) => {
            if (!launchParams.files.length) return;
            try { loadFiles([await launchParams.files[0].getFile()]); } 
            catch (err) { console.error("File Error:", err); }
        });
    }
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');

    let touchStartX=0, touchEndX=0;
    
    window.onload = () => { 
        try { 
            loadLibraryFromStorage();
            loadFromGitHubAPI(); // Auto-load from repo
            loadHistory(); 
            checkResume(); 
            
            const ta = document.getElementById('touch-area');
            ta.addEventListener('touchstart', e => touchStartX = e.changedTouches[0].screenX);
            ta.addEventListener('touchend', e => { touchEndX = e.changedTouches[0].screenX; handleSwipe(); });
        } catch(e){ console.error(e); } 
    };

    function handleSwipe() {
        if (touchStartX - touchEndX > 50) nextQ();
        else if (touchEndX - touchStartX > 50) prevQ();
    }

    // --- NEW: FETCH LIST DIRECTLY FROM GITHUB API ---
    async function loadFromGitHubAPI() {
        try {
            const apiUrl = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/tests`;
            const res = await fetch(apiUrl);
            if (!res.ok) throw new Error("Failed to fetch repo contents");
            const data = await res.json();
            
            // Filter JSONs
            cloudList = data
                .filter(file => file.name.endsWith('.json') && file.type === 'file')
                .map(file => ({
                    name: file.name,
                    path: file.download_url, 
                    isCloud: true
                }));
            renderGrid();
        } catch (err) {
            console.error("Offline or API Limit:", err);
            renderGrid(); // Fallback to local only
        }
    }

    async function fetchAndLoad(item) {
        const btn = document.getElementById('start-btn');
        btn.innerText = "Loading...";
        try {
            const res = await fetch(item.path);
            const data = await res.json();
            
            library[item.name] = data;
            saveLibraryToStorage();
            
            activeFile = item.name;
            renderGrid();
            
            let shortName = item.name.replace(/\.json$/i,'').substring(0,10) + (item.name.length>10?'...':'');
            btn.innerText = 'START: ' + shortName;
            btn.disabled = false;
        } catch(e) {
            alert("Failed to load test: " + e.message);
            btn.innerText = "SELECT TEST";
        }
    }

    // --- PASTE JSON LOGIC ---
    function openPasteModal() { document.getElementById('pasteModal').style.display = 'flex'; }
    function closePasteModal() { document.getElementById('pasteModal').style.display = 'none'; }
    
    

    // --- NEW UNIFIED SAVE FUNCTION ---
async function saveAndSync() {
    const nameInput = document.getElementById('pasteFileName');
    const contentInput = document.getElementById('pasteContent');
    const name = nameInput.value.trim();
    const content = contentInput.value.trim();
    
    // 1. Validation
    if(!name || !content) { alert("Please enter filename and content."); return; }
    
    let parsed;
    try {
        parsed = JSON.parse(content);
    } catch(e) { 
        alert("Invalid JSON code. Please check formatting."); 
        return; 
    }

    // 2. SAVE LOCALLY (Immediate Access)
    try {
        const fileName = name.endsWith('.json') ? name : name + '.json';
        library[fileName] = parsed;
        saveLibraryToStorage();
        
        // Auto-select the new test so user can play immediately
        activeFile = fileName;
        renderGrid(); 
        
        // Update the Start Button text to show it's ready
        let shortName = fileName.replace(/\.json$/i,'').substring(0,10) + (fileName.length>10?'...':'');
        document.getElementById('start-btn').innerText = 'START: ' + shortName;
        document.getElementById('start-btn').disabled = false;

        // 3. COPY TO CLIPBOARD & OPEN GITHUB (Background Process)
        await navigator.clipboard.writeText(content);
        
        const title = encodeURIComponent(fileName);
        // We use the variables REPO_OWNER and REPO_NAME defined at the top of your script
        const url = `https://github.com/${REPO_OWNER}/${REPO_NAME}/issues/new?title=${title}&labels=new-test`;
        
        // Open GitHub in new tab
        window.open(url, '_blank');
        
        // Cleanup UI
        closePasteModal();
        nameInput.value = '';
        contentInput.value = '';
        
        // Final Confirmation
        alert(`‚úÖ Test "${fileName}" is ready in your library!\n\nGitHub Issue tab opened. Paste the code (Ctrl+V) there to sync with Cloud.`);
        
    } catch(err) {
        console.error(err);
        alert("Saved locally, but failed to open GitHub or Copy to Clipboard. You can play the test locally now.");
        closePasteModal();
    }
}

    // --- RENDER GRID (LIST VIEW) ---
    function renderGrid() {
        const grid = document.getElementById('file-grid');
        grid.innerHTML = '';
        const search = document.getElementById('searchInput').value.toLowerCase();
        
        // Merge Local and Cloud
        let masterMap = new Map();
        cloudList.forEach(item => {
            masterMap.set(item.name, { ...item, source: 'cloud', qCount: 'Tap to Load' });
        });
        Object.keys(library).forEach(name => {
            masterMap.set(name, { name: name, source: 'local', qCount: library[name].length + ' Qs' });
        });

        // Filter and Sort Alphabetically
        let displayList = Array.from(masterMap.values()).filter(item => 
            item.name.toLowerCase().includes(search)
        );
        displayList.sort((a, b) => a.name.localeCompare(b.name));

        displayList.forEach(item => {
            const d = document.createElement('div');
            d.className = 'file-card';
            if (isMultiMode && selectedFiles.has(item.name)) d.classList.add('multi-selected');
            else if (item.name === activeFile) d.classList.add('active');

            const icon = item.source === 'local' ? 'üìÇ' : '‚òÅÔ∏è';
            const metaColor = item.source === 'local' ? '#666' : 'var(--accent)';
            
            d.innerHTML = `
                <div class="status-badge">${icon}</div>
                <span class="file-name">${item.name}</span>
                <small class="file-meta" style="color:${metaColor}">${item.qCount}</small>
                <div class="multi-check">‚úî</div>
            `;
            
            d.onclick = async () => {
                if(isMultiMode) {
                   handleCardClick(item.name); // Only works if local
                } else {
                    if(item.source === 'local') handleCardClick(item.name);
                    else await fetchAndLoad(item);
                }
            };
            grid.appendChild(d);
        });
        if(displayList.length === 0) grid.innerHTML = '<div style="color:#999; padding:20px; text-align:center;">No tests found.</div>';
    }

    document.getElementById('jsonFile').onchange = (e) => loadFiles(e.target.files);
    function loadLibraryFromStorage() {
        const savedLib = localStorage.getItem(LIB_KEY);
        if(savedLib) { try { library = JSON.parse(savedLib); renderGrid(); } catch(e){} }
    }
    function saveLibraryToStorage() { try { localStorage.setItem(LIB_KEY, JSON.stringify(library)); } catch(e){ alert("Full Storage"); } }

    function loadFiles(files) {
        if(!files.length) return;
        Array.from(files).forEach(f => {
            const r = new FileReader();
            r.onload = e => { 
                try { library[f.name] = JSON.parse(e.target.result); saveLibraryToStorage(); renderGrid(); } 
                catch(x){ alert('Invalid JSON'); }
            };
            r.readAsText(f);
        });
    }

    function toggleMultiSelect() {
        isMultiMode = !isMultiMode;
        selectedFiles.clear();
        document.getElementById('multiToggle').classList.toggle('active');
        renderGrid();
        document.getElementById('start-btn').disabled = true;
        document.getElementById('start-btn').innerText = "SELECT TEST";
    }

    function handleCardClick(name) {
        // Ensure file is loaded locally
        if (!library[name]) return; 

        if (isMultiMode) {
            if (selectedFiles.has(name)) selectedFiles.delete(name);
            else selectedFiles.add(name);
            const btn = document.getElementById('start-btn');
            if (selectedFiles.size > 0) {
                let totalQs = 0;
                selectedFiles.forEach(f => totalQs += library[f].length);
                btn.innerText = `START COMBINED`;
                btn.disabled = false;
            } else { btn.innerText = "SELECT TEST"; btn.disabled = true; }
        } else {
            activeFile = name;
            let shortName = name.replace(/\.json$/i,'').substring(0,10) + (name.length>10?'...':'');
            document.getElementById('start-btn').innerText = 'START: ' + shortName;
            document.getElementById('start-btn').disabled = false;
        }
        renderGrid();
    }

    // --- NEW: GROUPING & SHUFFLING LOGIC ---
    function prepareQuestions(sourceList) {
        // 1. Group by Passage or GroupID
        let groups = [];
        let currentGroup = [];
        sourceList.forEach((q, index) => {
            if (index === 0) { currentGroup.push(q); } 
            else {
                const prevQ = sourceList[index - 1];
                const samePassage = q.passage && prevQ.passage && (q.passage.trim() === prevQ.passage.trim());
                const sameGroup = q.group_id && prevQ.group_id && (q.group_id === prevQ.group_id);
                if (samePassage || sameGroup) { currentGroup.push(q); } 
                else { groups.push(currentGroup); currentGroup = [q]; }
            }
        });
        if (currentGroup.length > 0) groups.push(currentGroup);

        // 2. Shuffle Groups
        for (let i = groups.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [groups[i], groups[j]] = [groups[j], groups[i]];
        }

        // 3. Flatten and Shuffle Options (Conditionally)
        let flatList = groups.flat();
        return flatList.map(q => {
            let newQ = JSON.parse(JSON.stringify(q));
            
            // Check for tricky options
            const trickyKeywords = ["Both", "All of", "None of", "Only A", "Only B"];
            const hasTrickyOption = newQ.options.some(opt => trickyKeywords.some(kw => opt.includes(kw)));
            
            if (newQ.noShuffle !== true && !hasTrickyOption) {
                let correctText = newQ.options[newQ.answer];
                for (let i = newQ.options.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [newQ.options[i], newQ.options[j]] = [newQ.options[j], newQ.options[i]];
                }
                newQ.answer = newQ.options.indexOf(correctText);
            }
            return newQ;
        });
    }

    function startExam() {
        if(localStorage.getItem(KEY)) if(!confirm("Discard current progress?")) return;
        isReviewMode = false;
        let rawQuestions = [];
        if (isMultiMode) {
            if (selectedFiles.size === 0) return;
            selectedFiles.forEach(f => { if(library[f]) rawQuestions.push(...library[f]); });
            activeFile = "Combined Test";
        } else {
            if(!activeFile || !library[activeFile]) return;
            rawQuestions = library[activeFile];
        }
        questions = prepareQuestions(rawQuestions);
        responses = {}; confidence = {}; visited = {}; 
        qTimers = {}; currIdx = 0; lastQTime = 0;
        
        const h = parseInt(document.getElementById('hInput').value)||0;
        const m = parseInt(document.getElementById('mInput').value)||0;
        const s = parseInt(document.getElementById('sInput').value)||0;
        seconds = (h*3600)+(m*60)+s || 3600; 
        initExamUI();
    }

    function startSmartReview() {
        if(!reviewSet || reviewSet.length === 0) return;
        if(confirm(`Start Review Mode?`)) {
            isReviewMode = true;
            questions = prepareQuestions(reviewSet);
            let baseName = activeFile.replace(/\.json$/i, '').replace(/ \(Review\)$/i, '');
            activeFile = baseName + " (Review)";
            responses = {}; confidence = {}; visited = {}; currIdx = 0;
            seconds = 0; qTimers = {}; lastQTime = 0;
            initExamUI();
        }
    }

    function retakeTest(fname, duration) {
        if(!library[fname] && !fname.startsWith("Combined")) { alert(`File missing.`); return; }
        if(!confirm(`Retake "${fname}"?`)) return;
        isReviewMode = false;
        let rawQuestions = [];
        if(fname.startsWith("Combined")) { alert("Re-select files."); return; } 
        else { rawQuestions = library[fname]; activeFile = fname; }
        questions = prepareQuestions(rawQuestions); 
        seconds = duration || 3600;
        const h = Math.floor(seconds/3600), m = Math.floor((seconds%3600)/60), s = seconds%60;
        document.getElementById('hInput').value = h; document.getElementById('mInput').value = m; document.getElementById('sInput').value = s;
        responses = {}; confidence = {}; visited = {}; qTimers = {}; lastQTime = 0; currIdx = 0;
        if(localStorage.getItem(KEY)) localStorage.removeItem(KEY);
        initExamUI();
    }

    function initExamUI() {
        document.getElementById('upload-screen').classList.remove('active');
        document.getElementById('result-screen').classList.remove('active');
        document.getElementById('exam-screen').classList.add('active');
        let cleanTitle = activeFile.replace(/\.json$/i, ''); 
        document.getElementById('exam-title').innerText = cleanTitle.length > 35 ? cleanTitle.substring(0,35)+'...' : cleanTitle;
        
        const header = document.getElementById('main-header');
        const timerBox = document.getElementById('timer');
        if(isReviewMode) {
            header.classList.add('review-mode');
            timerBox.classList.add('review-timer');
        } else {
            header.classList.remove('review-mode');
            timerBox.classList.remove('review-timer');
        }

        questions.forEach((_,i) => visited[i]=false);
        startTimer(); loadQ(0); saveState();
    }

    function loadQ(i) {
        // --- TIMER LOGIC ---
        const now = Date.now();
        if (lastQTime !== 0) {
            const diff = (now - lastQTime) / 1000; 
            qTimers[currIdx] = (qTimers[currIdx] || 0) + diff; 
        }
        lastQTime = now; 

        currIdx = i; visited[i] = true;
        const q = questions[i];
        
        const passDiv = document.getElementById('pane-passage');
        if(q.passage) { passDiv.classList.add('active'); document.getElementById('passage-content').innerHTML = q.passage; }
        else { passDiv.classList.remove('active'); }

        document.getElementById('q-num').innerText = i+1;
        document.getElementById('q-sec').innerText = q.section || '-';
        document.getElementById('q-topic').innerText = q.topic || '-';
        document.getElementById('q-text').innerHTML = q.question;
        const box = document.getElementById('options-box'); box.innerHTML = '';
        q.options.forEach((opt, idx) => {
            const div = document.createElement('div'); div.className = 'opt-label';
            if(responses[i] === idx) div.classList.add('selected');
            div.onclick = () => { responses[i] = idx; loadQ(i); saveState(); };
            div.innerHTML = `<input type="radio" ${responses[i]===idx?'checked':''}> ${opt}`;
            box.appendChild(div);
        });

        const cBox = document.getElementById('conf-box');
        const cBtns = document.querySelectorAll('.c-btn');
        if(responses[i] !== undefined) {
            cBox.classList.add('active');
            cBtns.forEach(b => {
                b.classList.remove('sel');
                if(b.innerText === confidence[i]) b.classList.add('sel');
            });
        } else {
            cBox.classList.remove('active');
            cBtns.forEach(b => b.classList.remove('sel'));
        }

        const btn = document.getElementById('next-btn');
        if(i === questions.length-1) { btn.innerText = "Submit Test"; btn.style.background = "#e67e22"; }
        else { btn.innerText = "Save & Next"; btn.style.background = "#2962ff"; }
        renderPalette();
        saveState();
    }

    function setConf(val) { confidence[currIdx] = val; loadQ(currIdx); saveState(); }
    function clearRes() { delete responses[currIdx]; delete confidence[currIdx]; loadQ(currIdx); saveState(); }
    function nextQ() { if(currIdx < questions.length-1) loadQ(currIdx+1); else submitExam(); }
    function prevQ() { if(currIdx > 0) loadQ(currIdx-1); }

    function renderPalette() {
        const p = document.getElementById('palette');
        p.innerHTML = '';
        questions.forEach((_, i) => {
            const b = document.createElement('div'); b.className = 'pal-btn'; b.innerText = i+1;
            if(i===currIdx) b.classList.add('current');
            if(responses[i]!==undefined) b.classList.add('ans');
            else if(visited[i]) b.classList.add('visit');
            b.onclick = () => { loadQ(i); if(window.innerWidth<=768) closeSidebar(); };
            p.appendChild(b);
        });
    }

    function startTimer() {
        clearInterval(timer);
        timer = setInterval(() => {
            if(isReviewMode) seconds++; else { seconds--; if(seconds<=0) submitExam(true); }
            
            const h = Math.floor(seconds/3600).toString().padStart(2,'0');
            const m = Math.floor((seconds%3600)/60).toString().padStart(2,'0');
            const s = (seconds%60).toString().padStart(2,'0');
            const tEl = document.getElementById('timer');
            tEl.innerText = `${h}:${m}:${s}`;
            
            if(!isReviewMode) seconds < 60 ? tEl.classList.add('critical') : tEl.classList.remove('critical');
        }, 1000);
    }

    function saveState() {
        localStorage.setItem(KEY, JSON.stringify({ library, activeFile, questions, responses, confidence, visited, currIdx, seconds, isReviewMode, qTimers, lastQTime }));
    }

    function checkResume() { if(localStorage.getItem(KEY)) document.getElementById('resume-btn').style.display = 'inline-block'; }

    function resumeExam() {
        const d = JSON.parse(localStorage.getItem(KEY));
        loadLibraryFromStorage();
        activeFile = d.activeFile; questions = d.questions;
        responses = d.responses; confidence = d.confidence; visited = d.visited;
        currIdx = d.currIdx; seconds = d.seconds; isReviewMode = d.isReviewMode;
        qTimers = d.qTimers || {}; 
        lastQTime = Date.now(); // Reset to avoid offline drift
        initExamUI();
    }

    function submitExam(force=false) {
        if(!force && !confirm("End Exam?")) return;
        clearInterval(timer); 

        // Capture last question time
        const now = Date.now();
        if (lastQTime !== 0) {
            qTimers[currIdx] = (qTimers[currIdx] || 0) + ((now - lastQTime) / 1000);
        }
        lastQTime = 0; 
        
        localStorage.removeItem(KEY);

        let score=0, cor=0, wrg=0, skip=0;
        let tStats={}, cStats={ '100% Sure':{c:0,w:0}, '50:50':{c:0,w:0}, 'Logical':{c:0,w:0}, 'Guess':{c:0,w:0} };
        reviewSet = [];
        
        const radios = document.getElementsByName('pMode');
        let mode = 'auto';
        for(let r of radios) { if(r.checked) mode = r.value; }
        let modeLabel = '';

        questions.forEach((q, i) => {
            const ans = responses[i]; const conf = confidence[i];
            if(!tStats[q.topic]) tStats[q.topic] = {t:0, c:0, w:0}; tStats[q.topic].t++;
            let isWrong = false; let isSkipped = false;
            let qMark = 1, qNeg = 0.25;

            if (mode === '2') { qMark = 2.0; qNeg = 0.5; modeLabel = "Forced Paper 2 (+2 / -0.5)"; } 
            else if (mode === '1') { qMark = 1.25; qNeg = 0.3125; modeLabel = "Paper 1 (+1.25 / -0.3125)"; } 
            else {
                qMark = q.marks ? parseFloat(q.marks) : 1.0;
                qNeg = q.negative ? parseFloat(q.negative) : (qMark * 0.25);
                modeLabel = "Auto-Detected from JSON";
            }

            if(ans === undefined) { skip++; isSkipped=true; } 
            else {
                if(ans === q.answer) {
                    score += qMark; cor++; tStats[q.topic].c++;
                    if(conf) cStats[conf].c++;
                } else {
                    score -= qNeg; wrg++; tStats[q.topic].w++;
                    if(conf) cStats[conf].w++;
                    isWrong = true;
                }
            }

            if (isWrong || isSkipped || (conf === 'Guess' || conf === 'Logical')) {
                reviewSet.push(q);
            }
        });

        if(!isReviewMode) {
            const totalDuration = parseInt(document.getElementById('hInput').value)*3600 + 
                                  parseInt(document.getElementById('mInput').value)*60 + 
                                  parseInt(document.getElementById('sInput').value);
            let h = JSON.parse(localStorage.getItem(HIST)||'[]');
            h.unshift({name:activeFile, score:score.toFixed(2), date:new Date().toLocaleDateString(), dur: totalDuration});
            localStorage.setItem(HIST, JSON.stringify(h));
        }

        document.getElementById('exam-screen').classList.remove('active');
        document.getElementById('result-screen').classList.add('active');
        
        const reviewBtn = document.getElementById('smart-review-btn');
        if(reviewSet.length > 0) { reviewBtn.style.display = 'flex'; reviewBtn.innerText = "Smart Review"; } 
        else { reviewBtn.style.display = 'none'; }

        document.getElementById('res-fname').innerText = activeFile.replace(/\.json$/i, '');
        document.getElementById('res-mode').innerText = modeLabel;
        document.getElementById('r-score').innerText = score.toFixed(2);
        document.getElementById('r-cor').innerText = cor;
        document.getElementById('r-wrg').innerText = wrg;
        document.getElementById('r-skip').innerText = skip;

        const tConf = document.getElementById('tbl-conf').querySelector('tbody'); tConf.innerHTML='';
        Object.keys(cStats).forEach(k => {
            const d = cStats[k], tot = d.c+d.w;
            tConf.innerHTML += `<tr><td>${k}</td><td class="txt-green">${d.c}</td><td class="txt-red">${d.w}</td><td>${tot}</td><td>${tot?Math.round((d.c/tot)*100):0}%</td></tr>`;
        });
        const tTopic = document.getElementById('tbl-topic').querySelector('tbody'); tTopic.innerHTML='';
        Object.keys(tStats).forEach(k => {
            const d = tStats[k];
            tTopic.innerHTML += `<tr><td>${k}</td><td>${d.t}</td><td class="txt-green">${d.c}</td><td class="txt-red">${d.w}</td></tr>`;
        });
        
        // --- DETAILED REVIEW WITH TIMER ---
        const rev = document.getElementById('review-list'); rev.innerHTML = '';
        questions.forEach((q, i) => {
            const ans = responses[i]; const userConf = confidence[i] || 'None';
            let cls = 'skip', uAns = 'Skipped', status = 'Skipped';
            
            // Time Calc
            let timeSec = Math.round(qTimers[i] || 0);
            let timeString = timeSec + 's';
            if(timeSec > 60) timeString = Math.floor(timeSec/60) + 'm ' + (timeSec%60) + 's';

            if(ans !== undefined) {
                if(ans === q.answer) { cls='correct'; uAns=q.options[ans]; status='Correct'; }
                else { cls='wrong'; uAns=q.options[ans]; status='Wrong'; }
            }
            
            rev.innerHTML += `
                <div class="review-item ${cls}">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; padding-bottom:5px; border-bottom:1px solid #eee;">
                        <span style="font-weight:bold;">Q${i+1} (${status})</span>
                        <div style="display:flex; gap:10px;">
                            <span style="font-size:0.8rem; background:#eee; color:#333; padding:2px 8px; border-radius:4px;">‚è± ${timeString}</span>
                            ${ans !== undefined ? `<span style="font-size:0.8rem; background:#333; color:#fff; padding:2px 8px; border-radius:4px;">${userConf}</span>` : ''}
                        </div>
                    </div>
                    <div style="margin-bottom:10px; font-size:1.05rem;">${q.question}</div>
                    <div style="font-size:0.95rem;">
                        You: <b>${uAns}</b> <br>
                        Ans: <span class="txt-green">${q.options[q.answer]}</span>
                    </div>
                    <div style="margin-top:10px; padding:10px; background:#f9f9f9; font-size:0.9rem; border-radius:4px;">
                        <b>Exp:</b> ${q.explanation}
                    </div>
                </div>`;
        });
    }

    function toggleSidebar() { 
        const s = document.getElementById('pane-sidebar'); 
        s.classList.toggle('collapsed');
        document.querySelector('.sidebar-handle').innerText = s.classList.contains('collapsed') ? '‚óÄ' : '‚ñ∂';
    }
    function openSidebar() { document.getElementById('pane-sidebar').classList.add('open'); document.getElementById('overlay').classList.add('active'); }
    function closeSidebar() { document.getElementById('pane-sidebar').classList.remove('open'); document.getElementById('overlay').classList.remove('active'); }
    
    function loadHistory() {
        const h = JSON.parse(localStorage.getItem(HIST)||'[]');
        const l = document.getElementById('history-list'); l.innerHTML = '';
        if(h.length) {
            document.getElementById('no-history').style.display='none';
            h.slice(0,10).forEach(x => {
                let displayName = x.name.replace(/\.json$/i, '');
                l.innerHTML += `<tr><td>${displayName}<br><small>${x.date}</small></td><td><b>${x.score}</b></td><td><button class="retake" onclick="retakeTest('${x.name}', ${x.dur})">Retake</button></td></tr>`;
            });
        }
    }
    function clearHistory() { localStorage.removeItem(HIST); loadHistory(); }
    
    function returnToLibrary() {
        document.getElementById('result-screen').classList.remove('active');
        document.getElementById('upload-screen').classList.add('active');
        renderGrid(); loadHistory();
    }

    function downloadRes() {
        const html = document.getElementById('result-screen').innerHTML;
        const css = document.getElementsByTagName('style')[0].innerText;
        const blob = new Blob([`<html><head><style>${css} body{overflow:visible;} #result-screen{display:block!important;}</style></head><body><div id="result-screen">${html}</div></body></html>`], {type:'text/html'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = `Result_${activeFile.replace('.json','').replace(/[^a-z0-9]/gi, '_')}.html`; a.click();
    }
</script>
</body>
</html>
